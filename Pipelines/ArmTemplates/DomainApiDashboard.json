{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "siteName": { "type": "string", "minLength": 1 },
    "appInsightsLocation": { "type": "string", "minLength": 1 },
    "appServicePlan": { "type": "string", "minLength": 1 },
    "environmentName": { "type": "string", "minLength": 1 }
  },
  "variables": {
  },
  "resources": [
    {
      "name": "[concat(parameters('siteName'),'-usage-dashboard')]",
      "type": "Microsoft.Portal/dashboards",
      "apiVersion": "2015-08-01-preview",
      "location": "[parameters('appInsightsLocation')]",
      "tags": {},
      "properties": {
        "lenses": {
          "0": {
            "order": 0,
            "parts": {
              "0": {
                "position": {
                  "x": 0,
                  "y": 0,
                  "colSpan": 16,
                  "rowSpan": 1
                },
                "metadata": {
                  "inputs": [],
                  "type": "Extension/HubsExtension/PartType/MarkdownPart",
                  "settings": {
                    "content": {
                      "settings": {
                        "content": "# Domain API - Usage monitor",
                        "title": "",
                        "subtitle": "",
                        "markdownSource": 1
                      }
                    }
                  }
                }
              },
              "1": {
                "position": {
                  "x": 16,
                  "y": 0,
                  "colSpan": 2,
                  "rowSpan": 1
                },
                "metadata": {
                  "inputs": [],
                  "type": "Extension/HubsExtension/PartType/MarkdownPart",
                  "settings": {
                    "content": {
                      "settings": {
                        "content": "<img height=\"52\" src=\"https://nfieldoperations.blob.core.windows.net/dashboardmediafiles/SimpleWorldMap_EU.png\"/>",
                        "title": "",
                        "subtitle": ""
                      }
                    }
                  }
                }
              },
              "2": {
                "position": {
                  "x": 0,
                  "y": 1,
                  "colSpan": 6,
                  "rowSpan": 4
                },
                "metadata": {
                  "inputs": [
                    {
                      "name": "options",
                      "isOptional": true
                    },
                    {
                      "name": "sharedTimeRange",
                      "isOptional": true
                    }
                  ],
                  "type": "Extension/HubsExtension/PartType/MonitorChartPart",
                  "settings": {
                    "content": {
                      "options": {
                        "chart": {
                          "metrics": [
                            {
                              "resourceMetadata": {
                                "id": "[resourceId('Microsoft.Web/serverFarms', parameters('appServicePlan'))]"
                              },
                              "name": "CpuPercentage",
                              "aggregationType": 4,
                              "namespace": "microsoft.web/serverfarms",
                              "metricVisualization": {
                                "displayName": "CPU Percentage",
                                "resourceDisplayName": "[parameters('environmentName')]"
                              }
                            },
                            {
                              "resourceMetadata": {
                                "id": "[resourceId('Microsoft.Web/serverFarms', parameters('appServicePlan'))]"
                              },
                              "name": "MemoryPercentage",
                              "aggregationType": 4,
                              "namespace": "microsoft.web/serverfarms",
                              "metricVisualization": {
                                "displayName": "Memory Percentage",
                                "resourceDisplayName": "[parameters('appServicePlan')]"
                              }
                            }
                          ],
                          "title": "Avg CPU Percentage and Avg Memory Percentage",
                          "titleKind": 1,
                          "visualization": {
                            "chartType": 2,
                            "legendVisualization": {
                              "isVisible": true,
                              "position": 2,
                              "hideSubtitle": false
                            },
                            "axisVisualization": {
                              "x": {
                                "isVisible": true,
                                "axisType": 2
                              },
                              "y": {
                                "isVisible": true,
                                "axisType": 1
                              }
                            },
                            "disablePinning": true
                          }
                        }
                      }
                    }
                  }
                }
              },
              "3": {
                "position": {
                  "x": 6,
                  "y": 1,
                  "colSpan": 6,
                  "rowSpan": 4
                },
                "metadata": {
                  "inputs": [
                    {
                      "name": "resourceTypeMode",
                      "isOptional": true
                    },
                    {
                      "name": "ComponentId",
                      "isOptional": true
                    },
                    {
                      "name": "Scope",
                      "value": {
                        "resourceIds": [
                          "[resourceId('microsoft.insights/components', parameters('siteName'))]"
                        ]
                      },
                      "isOptional": true
                    },
                    {
                      "name": "PartId",
                      "value": "73424b6b-068a-4bb6-8703-a7f78d532734",
                      "isOptional": true
                    },
                    {
                      "name": "Version",
                      "value": "2.0",
                      "isOptional": true
                    },
                    {
                      "name": "TimeRange",
                      "isOptional": true
                    },
                    {
                      "name": "DashboardId",
                      "isOptional": true
                    },
                    {
                      "name": "DraftRequestParameters",
                      "isOptional": true
                    },
                    {
                      "name": "Query",
                      "value": "let x = requests\n| where timestamp > ago(30d)\n| project Activity = strcat_array(split(replace_string(\n    replace_regex(replace_regex(name,@\"[({]?[a-fA-F0-9]{8}[-]?([a-fA-F0-9]{4}[-]?){3}[a-fA-F0-9]{12}[})]?\",@\"{guid}\"),@\"\\/\\d*\\/\",@\"/{num}/\")    \n    ,\" v1\",\" /v1\"),\"/\"),\"/\"),\nItemCount = itemCount,\nTime = timestamp\n| summarize Count = sum(ItemCount) by  Activity\n|top 10 by Count;\nlet y = requests\n| where timestamp > ago(30d)\n| project Activity = strcat_array(split(replace_string(\n    replace_regex(replace_regex(name,@\"[({]?[a-fA-F0-9]{8}[-]?([a-fA-F0-9]{4}[-]?){3}[a-fA-F0-9]{12}[})]?\",@\"{guid}\"),@\"\\/\\d*\\/\",@\"/{num}/\")    \n    ,\" v1\",\" /v1\"),\"/\"),\"/\"),\nItemCount = itemCount,\nTime = timestamp;\nx\n| join kind=inner (y) on Activity\n|project Activity,Time, ItemCount\n| summarize ['number of calls'] = sum(ItemCount) by bin(Time, 4h),  Activity\n| render timechart\n",
                      "isOptional": true
                    },
                    {
                      "name": "ControlType",
                      "value": "FrameControlChart",
                      "isOptional": true
                    },
                    {
                      "name": "SpecificChart",
                      "value": "Line",
                      "isOptional": true
                    },
                    {
                      "name": "PartTitle",
                      "value": "Analytics",
                      "isOptional": true
                    },
                    {
                      "name": "PartSubTitle",
                      "value": "",
                      "isOptional": true
                    },
                    {
                      "name": "Dimensions",
                      "value": {
                        "xAxis": {
                          "name": "Time",
                          "type": "datetime"
                        },
                        "yAxis": [
                          {
                            "name": "number of calls",
                            "type": "long"
                          }
                        ],
                        "splitBy": [
                          {
                            "name": "Activity",
                            "type": "string"
                          }
                        ],
                        "aggregation": "Sum"
                      },
                      "isOptional": true
                    },
                    {
                      "name": "LegendOptions",
                      "value": {
                        "isEnabled": true,
                        "position": "Bottom"
                      },
                      "isOptional": true
                    },
                    {
                      "name": "IsQueryContainTimeRange",
                      "value": true,
                      "isOptional": true
                    }
                  ],
                  "type": "Extension/Microsoft_OperationsManagementSuite_Workspace/PartType/LogsDashboardPart",
                  "settings": {
                    "content": {
                      "Query": "let x = requests\n| where timestamp > ago(30d) and name contains \" /v2/\"\n| project Activity = strcat_array(split(replace_string(\n    replace_regex(replace_regex(name,@\"[({]?[a-fA-F0-9]{8}[-]?([a-fA-F0-9]{4}[-]?){3}[a-fA-F0-9]{12}[})]?\",@\"{guid}\"),@\"\\/\\d*\\/\",@\"/{num}/\")    \n    ,\" v2\",\" /v2\"),\"/\"),\"/\"),\nItemCount = itemCount,\nName = name,\nTime = timestamp\n| summarize Count = sum(ItemCount) by  Activity\n|top 10 by Count;\nlet y = requests\n| where timestamp > ago(30d) and name contains \" /v2/\"\n| project Activity = strcat_array(split(replace_string(\n    replace_regex(replace_regex(name,@\"[({]?[a-fA-F0-9]{8}[-]?([a-fA-F0-9]{4}[-]?){3}[a-fA-F0-9]{12}[})]?\",@\"{guid}\"),@\"\\/\\d*\\/\",@\"/{num}/\")    \n    ,\" v2\",\" /v2\"),\"/\"),\"/\"),\nItemCount = itemCount,\nName = name,\nTime = timestamp;\nx\n| join kind=inner (y) on Activity\n|project Activity,Time, ItemCount\n| summarize ['number of calls'] = sum(ItemCount) by bin(Time, 4h),  Activity\n| render timechart\n\n",
                      "PartTitle": "Number of calls per endpoint",
                      "PartSubTitle": "nr of calls per 4 hours"
                    }
                  }
                }
              },
              "4": {
                "position": {
                  "x": 12,
                  "y": 1,
                  "colSpan": 6,
                  "rowSpan": 4
                },
                "metadata": {
                  "inputs": [
                    {
                      "name": "resourceTypeMode",
                      "isOptional": true
                    },
                    {
                      "name": "ComponentId",
                      "isOptional": true
                    },
                    {
                      "name": "Scope",
                      "value": {
                        "resourceIds": [
                          "[resourceId('microsoft.insights/components', parameters('siteName'))]"
                        ]
                      },
                      "isOptional": true
                    },
                    {
                      "name": "PartId",
                      "value": "802588a0-7e6f-4abe-9124-29877c99d202",
                      "isOptional": true
                    },
                    {
                      "name": "Version",
                      "value": "2.0",
                      "isOptional": true
                    },
                    {
                      "name": "TimeRange",
                      "isOptional": true
                    },
                    {
                      "name": "DashboardId",
                      "isOptional": true
                    },
                    {
                      "name": "DraftRequestParameters",
                      "isOptional": true
                    },
                    {
                      "name": "Query",
                      "value": "let x = requests\n| where timestamp > ago(30d)\n| project ItemCount = itemCount,\nDomain = tostring(customDimensions.DomainId),\nTime = timestamp\n| summarize Count = sum(ItemCount) by  Domain\n|top 10 by Count;\nlet y = requests\n| where timestamp > ago(30d)\n| project ItemCount = itemCount,\nDomain = tostring(customDimensions.DomainId),\nTime = timestamp;\nx\n| join kind=inner (y) on Domain\n|project Domain,Time, ItemCount\n| summarize ['number of calls'] = sum(ItemCount) by bin(Time, 4h),  Domain\n| render timechart\n",
                      "isOptional": true
                    },
                    {
                      "name": "ControlType",
                      "value": "FrameControlChart",
                      "isOptional": true
                    },
                    {
                      "name": "SpecificChart",
                      "value": "Line",
                      "isOptional": true
                    },
                    {
                      "name": "PartTitle",
                      "value": "Analytics",
                      "isOptional": true
                    },
                    {
                      "name": "PartSubTitle",
                      "value": "",
                      "isOptional": true
                    },
                    {
                      "name": "Dimensions",
                      "value": {
                        "xAxis": {
                          "name": "Time",
                          "type": "datetime"
                        },
                        "yAxis": [
                          {
                            "name": "number of calls",
                            "type": "long"
                          }
                        ],
                        "splitBy": [
                          {
                            "name": "Domain",
                            "type": "string"
                          }
                        ],
                        "aggregation": "Sum"
                      },
                      "isOptional": true
                    },
                    {
                      "name": "LegendOptions",
                      "value": {
                        "isEnabled": true,
                        "position": "Bottom"
                      },
                      "isOptional": true
                    },
                    {
                      "name": "IsQueryContainTimeRange",
                      "value": true,
                      "isOptional": true
                    }
                  ],
                  "type": "Extension/Microsoft_OperationsManagementSuite_Workspace/PartType/LogsDashboardPart",
                  "settings": {
                    "content": {
                      "PartTitle": "Number of calls per domain",
                      "PartSubTitle": "nr of calls per 4 hours"
                    }
                  }
                }
              },
              "5": {
                "position": {
                  "x": 0,
                  "y": 5,
                  "colSpan": 6,
                  "rowSpan": 5
                },
                "metadata": {
                  "inputs": [
                    {
                      "name": "resourceTypeMode",
                      "isOptional": true
                    },
                    {
                      "name": "ComponentId",
                      "isOptional": true
                    },
                    {
                      "name": "Scope",
                      "value": {
                        "resourceIds": [
                          "[resourceId('microsoft.insights/components', parameters('siteName'))]"
                        ]
                      },
                      "isOptional": true
                    },
                    {
                      "name": "PartId",
                      "value": "15c4c706-371b-4ffd-9014-b9abb457ab56",
                      "isOptional": true
                    },
                    {
                      "name": "Version",
                      "value": "2.0",
                      "isOptional": true
                    },
                    {
                      "name": "TimeRange",
                      "isOptional": true
                    },
                    {
                      "name": "DashboardId",
                      "isOptional": true
                    },
                    {
                      "name": "DraftRequestParameters",
                      "isOptional": true
                    },
                    {
                      "name": "Query",
                      "value": "requests \n| where timestamp > ago(30d)\n| project ItemCount = itemCount,\nDomain = tostring(customDimensions.DomainId),\nTime = timestamp,\nCategory=  strcat(substring(resultCode,0,1),'xx')\n| where Category != \"2xx\"\n| summarize Count = sum(ItemCount) by bin(Time, 4h),  Category\n| render timechart\n",
                      "isOptional": true
                    },
                    {
                      "name": "ControlType",
                      "value": "FrameControlChart",
                      "isOptional": true
                    },
                    {
                      "name": "SpecificChart",
                      "value": "Line",
                      "isOptional": true
                    },
                    {
                      "name": "PartTitle",
                      "value": "Analytics",
                      "isOptional": true
                    },
                    {
                      "name": "PartSubTitle",
                      "value": "",
                      "isOptional": true
                    },
                    {
                      "name": "Dimensions",
                      "value": {
                        "xAxis": {
                          "name": "Time",
                          "type": "datetime"
                        },
                        "yAxis": [
                          {
                            "name": "Count",
                            "type": "long"
                          }
                        ],
                        "splitBy": [
                          {
                            "name": "Category",
                            "type": "string"
                          }
                        ],
                        "aggregation": "Sum"
                      },
                      "isOptional": true
                    },
                    {
                      "name": "LegendOptions",
                      "value": {
                        "isEnabled": true,
                        "position": "Bottom"
                      },
                      "isOptional": true
                    },
                    {
                      "name": "IsQueryContainTimeRange",
                      "value": true,
                      "isOptional": true
                    }
                  ],
                  "type": "Extension/Microsoft_OperationsManagementSuite_Workspace/PartType/LogsDashboardPart",
                  "settings": {
                    "content": {
                      "Query": "requests \n| where timestamp > ago(30d)\n| project ItemCount = itemCount,\nDomain = tostring(customDimensions.DomainId),\nTime = timestamp,\nCategory=  strcat(substring(resultCode,0,1),'xx')\n| where Category != \"2xx\"\n| summarize Count = sum(ItemCount) by bin(Time, 4h),  Category\n| render timechart\n\n",
                      "PartTitle": "Number of calls per result code (exclude 2xx)",
                      "PartSubTitle": "nr of calls per 4 hours"
                    }
                  }
                }
              },
              "6": {
                "position": {
                  "x": 6,
                  "y": 5,
                  "colSpan": 6,
                  "rowSpan": 5
                },
                "metadata": {
                  "inputs": [
                    {
                      "name": "resourceTypeMode",
                      "isOptional": true
                    },
                    {
                      "name": "ComponentId",
                      "isOptional": true
                    },
                    {
                      "name": "Scope",
                      "value": {
                        "resourceIds": [
                          "[resourceId('microsoft.insights/components', parameters('siteName'))]"
                        ]
                      },
                      "isOptional": true
                    },
                    {
                      "name": "PartId",
                      "value": "70e020ea-f491-4de0-b1a2-1960f115dec2",
                      "isOptional": true
                    },
                    {
                      "name": "Version",
                      "value": "2.0",
                      "isOptional": true
                    },
                    {
                      "name": "TimeRange",
                      "isOptional": true
                    },
                    {
                      "name": "DashboardId",
                      "isOptional": true
                    },
                    {
                      "name": "DraftRequestParameters",
                      "isOptional": true
                    },
                    {
                      "name": "Query",
                      "value": "requests \n| where timestamp > ago(30d)\n| project Activity = strcat_array(split(replace_string(\n    replace_regex(replace_regex(name,@\"[({]?[a-fA-F0-9]{8}[-]?([a-fA-F0-9]{4}[-]?){3}[a-fA-F0-9]{12}[})]?\",@\"{guid}\"),@\"\\/\\d*\\/\",@\"/{num}/\")    \n    ,\" v1\",\" /v1\"),\"/\"),\"/\"),\nDuration = duration*itemCount,\nItemCount = itemCount\n| summarize Count = sum(ItemCount), Duration = sum(Duration), averageDuration = sum(Duration)/sum(ItemCount) by  Activity\n| top 10 by Count\n",
                      "isOptional": true
                    },
                    {
                      "name": "ControlType",
                      "value": "AnalyticsGrid",
                      "isOptional": true
                    },
                    {
                      "name": "SpecificChart",
                      "isOptional": true
                    },
                    {
                      "name": "PartTitle",
                      "value": "Analytics",
                      "isOptional": true
                    },
                    {
                      "name": "PartSubTitle",
                      "value": "",
                      "isOptional": true
                    },
                    {
                      "name": "Dimensions",
                      "isOptional": true
                    },
                    {
                      "name": "LegendOptions",
                      "isOptional": true
                    },
                    {
                      "name": "IsQueryContainTimeRange",
                      "value": true,
                      "isOptional": true
                    }
                  ],
                  "type": "Extension/Microsoft_OperationsManagementSuite_Workspace/PartType/LogsDashboardPart",
                  "settings": {
                    "content": {
                      "GridColumnsWidth": {
                        "Count": "104px",
                        "Duration": "104px",
                        "averageDuration": "127px"
                      },
                      "Query": "requests \n| where timestamp > ago(30d) and name contains \" /v2/\"\n| project Activity = strcat_array(split(replace_string(\n    replace_regex(replace_regex(name,@\"[({]?[a-fA-F0-9]{8}[-]?([a-fA-F0-9]{4}[-]?){3}[a-fA-F0-9]{12}[})]?\",@\"{guid}\"),@\"\\/\\d*\\/\",@\"/{num}/\")    \n    ,\" v2\",\" /v2\"),\"/\"),\"/\"),\nDuration = duration*itemCount,\nItemCount = itemCount,\nName = name\n| summarize Count = sum(ItemCount), Duration = sum(Duration), averageDuration = sum(Duration)/sum(ItemCount) by  Activity\n| top 10 by Count\n\n",
                      "PartTitle": "Top 10 endpoints by number of calls",
                      "PartSubTitle": "Total nr of calls in the past 24 hours"
                    }
                  }
                }
              },
              "7": {
                "position": {
                  "x": 12,
                  "y": 5,
                  "colSpan": 6,
                  "rowSpan": 5
                },
                "metadata": {
                  "inputs": [
                    {
                      "name": "resourceTypeMode",
                      "isOptional": true
                    },
                    {
                      "name": "ComponentId",
                      "isOptional": true
                    },
                    {
                      "name": "Scope",
                      "value": {
                        "resourceIds": [
                          "[resourceId('microsoft.insights/components', parameters('siteName'))]"
                        ]
                      },
                      "isOptional": true
                    },
                    {
                      "name": "PartId",
                      "value": "8334fd8b-0889-4f25-a65e-3311c123ff7a",
                      "isOptional": true
                    },
                    {
                      "name": "Version",
                      "value": "2.0",
                      "isOptional": true
                    },
                    {
                      "name": "TimeRange",
                      "isOptional": true
                    },
                    {
                      "name": "DashboardId",
                      "isOptional": true
                    },
                    {
                      "name": "DraftRequestParameters",
                      "isOptional": true
                    },
                    {
                      "name": "Query",
                      "value": "requests \n| where timestamp > ago(30d)\n| project Duration = duration*itemCount,\nItemCount = itemCount,\nDomain = tostring(customDimensions.DomainId)\n| summarize Count = sum(ItemCount), Duration = sum(Duration), averageDuration = sum(Duration)/sum(ItemCount) by  Domain\n| top 10 by Count\n",
                      "isOptional": true
                    },
                    {
                      "name": "ControlType",
                      "value": "AnalyticsGrid",
                      "isOptional": true
                    },
                    {
                      "name": "SpecificChart",
                      "isOptional": true
                    },
                    {
                      "name": "PartTitle",
                      "value": "Analytics",
                      "isOptional": true
                    },
                    {
                      "name": "PartSubTitle",
                      "value": "",
                      "isOptional": true
                    },
                    {
                      "name": "Dimensions",
                      "isOptional": true
                    },
                    {
                      "name": "LegendOptions",
                      "isOptional": true
                    },
                    {
                      "name": "IsQueryContainTimeRange",
                      "value": true,
                      "isOptional": true
                    }
                  ],
                  "type": "Extension/Microsoft_OperationsManagementSuite_Workspace/PartType/LogsDashboardPart",
                  "settings": {
                    "content": {
                      "GridColumnsWidth": {
                        "Count": "89px",
                        "Duration": "107px"
                      },
                      "Query": "requests \n| where timestamp > ago(30d)\n| project Duration = duration*itemCount,\nItemCount = itemCount,\nDomain = tostring(customDimensions.DomainId)\n| summarize Count = sum(ItemCount), Duration = sum(Duration), averageDuration = sum(Duration)/sum(ItemCount) by  Domain\n| top 10 by Count\n\n",
                      "PartTitle": "Top 10 domains by number of calls",
                      "PartSubTitle": "Total nr of calls in the past 24 hours"
                    }
                  }
                }
              }
            }
          }
        }
      }
    }
  ]
}