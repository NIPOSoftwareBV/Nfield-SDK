{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "appServicePlan": {
      "type": "string",
      "minLength": 1
    },
    "appServicePlanSkuName": {
      "type": "string",
      "minLength": 1
    },
    "appServicePlanSkuCapacity": { "type": "int" },
    "appServicePlanLocation": {
      "type": "string",
      "minLength": 1
    },
    "appInsightsLocation": {
      "type": "string",
      "minLength": 1
    },
    "siteName": {
      "type": "string",
      "minLength": 1
    },
    "deployedBy": {
      "type": "string",
      "minLength": 1
    },
    "build": {
      "type": "string",
      "minLength": 1
    },
    "buildVersionLabel": {
      "type": "string",
      "minLength": 1
    },
    "interviewingRequestResponseTopicName": {
      "type": "string",
      "minLength": 1
    },
    "authorityUrl": {
      "type": "string",
      "minLength": 1
    },
    "tenant": {
      "type": "string",
      "minLength": 1
    },
    "keyVaultName": {
      "type": "string",
      "minLength": 1
    },
    "maxSamplingPercentage": {
      "type": "string",
      "defaultValue": "25"
    },
    "maxTelemetryItemsPerSecond": {
      "type": "string",
      "defaultValue": "5"
    },
    "reportingEventQueue": {
      "type": "string",
      "minLength": 1
    },
    "reportingEventQueueStaging": {
      "type": "string",
      "minLength": 1
    },
    "serviceBusTopicCreateSurvey": {
      "type": "string",
      "minLength": 1
    },
    "serviceBusTopicDeleteSurvey": {
      "type": "string",
      "minLength": 1
    },
    "databaseUserDecryptionKey": {
      "type": "securestring",
      "minLength": 1
    },
    "redisCacheConfiguration": {
      "type": "string",
      "minLength": 1
    },
    "managerCacheConnection": {
      "type": "securestring",
      "minLength": 1
    },
    "surveyCatalog": {
      "type": "securestring",
      "minLength": 1
    },
    "nfieldStorageAccount": {
      "type": "securestring",
      "minLength": 1
    },
    "reportingServiceBus": {
      "type": "securestring",
      "minLength": 1
    },
    "reportingServiceBusStaging": {
      "type": "securestring",
      "minLength": 1
    },
    "azureWebJobsServiceBus": {
      "type": "securestring",
      "minLength": 1
    },
    "domainApiAppRegistrationClientId": { "type": "securestring" },
    "alertsEmail": {
      "type": "string",
      "defaultValue": "niposoftware-teamgreen@kantar.com"
    },
    "managerBackgroundTaskQueueNameStaging": {
      "type": "string",
      "minLength": 1
    },
    "managerBackgroundTaskQueueName": {
      "type": "string",
      "minLength": 1
    },
    "managerActivityQueueNameStaging": {
      "type": "string",
      "minLength": 1
    },
    "managerActivityQueueName": {
      "type": "string",
      "minLength": 1
    },
    "toInterviewingTopicName": {
      "type": "string",
      "minLength": 1
    }
  },
  "variables": {
    "siteApplicationInsightsEnabled": true,
    "siteAppInsightsResource": "[if(variables('siteApplicationInsightsEnabled'), concat('Microsoft.Insights/components/', parameters('siteName')), 'empty')]",
    "siteProperties": {
      "alwaysOn": true,
      "httpLoggingEnabled": true,
      "detailedErrorLoggingEnabled": true,
      "requestTracingEnabled": true,
      "ftpsState": "Disabled",
      "defaultDocuments": ["swagger", "index.html"]
    },
    "actionGroupName": "[concat(parameters('siteName'),'-alerts-action-group')]"
  },
  "resources": [
    {
      "name": "[parameters('appServicePlan')]",
      "type": "Microsoft.Web/serverfarms",
      "apiVersion": "2018-02-01",
      "location": "[parameters('appServicePlanLocation')]",
      "sku": {
        "name": "[parameters('appServicePlanSkuName')]",
        "capacity": "[parameters('appServicePlanSkuCapacity')]"
      },
      "properties": {
        "name": "[parameters('appServicePlan')]"
      }
    },
    {
      "name": "[parameters('siteName')]",
      "type": "Microsoft.Web/sites",
      "apiVersion": "2020-12-01",
      "location": "[parameters('appServicePlanLocation')]",
      "identity": {
        "type": "SystemAssigned"
      },
      "tags": {
        "[concat('hidden-related:', resourceGroup().id, '/providers/Microsoft.Web/serverfarms/', parameters('appServicePlan'))]": "empty",
        "displayName": "[parameters('siteName')]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Web/serverfarms', parameters('appServicePlan'))]"
      ],
      "properties": {
        "name": "[parameters('siteName')]",
        "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', parameters('appServicePlan'))]",
        "siteConfig": {
          "use32BitWorkerProcess": false,
          "minTlsVersion": "1.2"
        }
      },
      "resources": [
        {
          "name": "web",
          "type": "config",
          "apiVersion": "2020-12-01",
          "dependsOn": [
            "[concat('Microsoft.Web/sites/', parameters('siteName'))]"
          ],
          "properties": "[variables('siteProperties')]"
        },
        {
          "name": "appsettings",
          "type": "config",
          "apiVersion": "2020-12-01",
          "dependsOn": [
            "[concat('Microsoft.Web/sites/', parameters('siteName'))]",
            "[concat('Microsoft.Web/sites/', parameters('siteName'), '/config/web')]"
          ],
          "tags": {
            "displayName": "appsettings"
          },
          "properties": {
            "ServiceBus:TopicCreateSurvey": "[parameters('serviceBusTopicCreateSurvey')]",
            "ServiceBus:TopicDeleteSurvey": "[parameters('serviceBusTopicDeleteSurvey')]",
            "InterviewingRequestResponseTopicName": "[parameters('interviewingRequestResponseTopicName')]",
            "ApplicationInsightsAgent_EXTENSION_VERSION": "~2",
            "XDT_MicrosoftApplicationInsights_Mode": "default",
            "MaxSamplingPercentage": "[parameters('maxSamplingPercentage')]",
            "MaxTelemetryItemsPerSecond": "[parameters('maxTelemetryItemsPerSecond')]",
            "ReportingEventQueue": "[parameters('reportingEventQueue')]",
            "DatabaseUserDecryptionKey": "[parameters('databaseUserDecryptionKey')]",
            "KeyVaultName": "[parameters('keyVaultName')]",
            "Tenant": "[parameters('tenant')]",
            "SSO:AuthorityUrl": "[parameters('authorityUrl')]",
            "DomainApiAppRegistrationClientId": "[parameters('domainApiAppRegistrationClientId')]",
            "APPLICATIONINSIGHTS_CONNECTION_STRING": "[if(variables('siteApplicationInsightsEnabled'), reference(variables('siteAppInsightsResource'),'2015-05-01')['ConnectionString'], 'empty')]",
            "ManagerBackgroundTaskQueueName": "[parameters('managerBackgroundTaskQueueName')]",
            "ManagerActivityQueueName": "[parameters('managerActivityQueueName')]",
            "ToInterviewingTopicName": "[parameters('toInterviewingTopicName')]"
          }
        },
        {
          "name": "connectionstrings",
          "type": "config",
          "apiVersion": "2020-12-01",
          "dependsOn": [
            "[concat('Microsoft.Web/sites/', parameters('siteName'))]",
            "[concat('Microsoft.Web/sites/', parameters('siteName'), '/config/web')]",
            "[concat('Microsoft.Web/sites/', parameters('siteName'), '/config/appsettings')]"
          ],
          "tags": {
            "displayName": "connectionstrings"
          },
          "properties": {
            "SurveyCatalog": {
              "type": "SQLAzure",
              "value": "[parameters('surveyCatalog')]"
            },
            "NfieldStorageAccount": {
              "type": "Custom",
              "value": "[parameters('nfieldStorageAccount')]"
            },
            "ReportingServiceBus": {
              "type": "Custom",
              "value": "[parameters('reportingServiceBus')]"
            },
            "AzureWebJobsServiceBus": {
              "type": "Custom",
              "value": "[parameters('azureWebJobsServiceBus')]"
            },
            "ManagerCacheConnection": {
              "type": "Custom",
              "value": "[parameters('managerCacheConnection')]"
            },
            "RedisCacheConfiguration": {
              "type": "Custom",
              "value": "[parameters('redisCacheConfiguration')]"
            }
          }
        },
        {
          "name": "slotconfignames",
          "type": "config",
          "apiVersion": "2015-08-01",
          "dependsOn": [
            "[resourceId('Microsoft.Web/sites', parameters('siteName'))]",
            "[concat('Microsoft.Web/sites/', parameters('siteName'), '/config/appsettings')]",
            "[concat('Microsoft.Web/sites/', parameters('siteName'), '/config/connectionstrings')]"
          ],
          "properties": {
            "appSettingNames": [ "InterviewingRequestResponseTopicName", "ReportingEventQueue", "ManagerBackgroundTaskQueueName", "ManagerActivityQueueName" ],
            "connectionStringNames": [ "ReportingServiceBus" ]
          }
        },
        {
          "name": "staging",
          "type": "slots",
          "apiVersion": "2020-12-01",
          "location": "[parameters('appServicePlanLocation')]",
          "identity": {
            "type": "SystemAssigned"
          },
          "dependsOn": [
            "[concat('Microsoft.Web/sites/', parameters('siteName'))]"
          ],
          "properties": {
            "siteConfig": {
              "use32BitWorkerProcess": false,
              "minTlsVersion": "1.2"
            }
          },
          "resources": [
            {
              "name": "web",
              "type": "config",
              "apiVersion": "2020-12-01",
              "dependsOn": [
                "[concat('Microsoft.Web/sites/', parameters('siteName'), '/slots/', 'staging')]"
              ],
              "properties": "[variables('siteProperties')]"
            },
            {
              "name": "appsettings",
              "type": "config",
              "apiVersion": "2020-12-01",
              "dependsOn": [
                "[concat('Microsoft.Web/sites/', parameters('siteName'), '/slots/staging')]",
                "[concat('Microsoft.Web/sites/', parameters('siteName'), '/slots/staging', '/config/web')]"
              ],
              "tags": {
                "displayName": "appsettings"
              },
              "properties": {
                "ServiceBus:TopicCreateSurvey": "[parameters('serviceBusTopicCreateSurvey')]",
                "ServiceBus:TopicDeleteSurvey": "[parameters('serviceBusTopicDeleteSurvey')]",
                "InterviewingRequestResponseTopicName": "[concat(parameters('interviewingRequestResponseTopicName'), '-staging')]",
                "ApplicationInsightsAgent_EXTENSION_VERSION": "~2",
                "XDT_MicrosoftApplicationInsights_Mode": "default",
                "MaxSamplingPercentage": "[parameters('maxSamplingPercentage')]",
                "MaxTelemetryItemsPerSecond": "[parameters('maxTelemetryItemsPerSecond')]",
                "ReportingEventQueue": "[parameters('reportingEventQueueStaging')]",
                "DatabaseUserDecryptionKey": "[parameters('databaseUserDecryptionKey')]",
                "DeployedBy": "[parameters('deployedBy')]",
                "Build": "[parameters('build')]",
                "BuildVersionLabel": "[parameters('buildVersionLabel')]",
                "KeyVaultName": "[parameters('keyVaultName')]",
                "Tenant": "[parameters('tenant')]",
                "SSO:AuthorityUrl": "[parameters('authorityUrl')]",
                "DomainApiAppRegistrationClientId": "[parameters('domainApiAppRegistrationClientId')]",
                "APPLICATIONINSIGHTS_CONNECTION_STRING": "[if(variables('siteApplicationInsightsEnabled'), reference(variables('siteAppInsightsResource'),'2015-05-01')['ConnectionString'], 'empty')]",
                "ManagerBackgroundTaskQueueName": "[parameters('managerBackgroundTaskQueueNameStaging')]",
                "ManagerActivityQueueName": "[parameters('managerActivityQueueNameStaging')]",
                "ToInterviewingTopicName": "[parameters('toInterviewingTopicName')]"
              }
            },
            {
              "name": "connectionstrings",
              "type": "config",
              "apiVersion": "2020-12-01",
              "dependsOn": [
                "[concat('Microsoft.Web/sites/', parameters('siteName'), '/slots/staging')]",
                "[concat('Microsoft.Web/sites/', parameters('siteName'), '/slots/staging', '/config/web')]",
                "[concat('Microsoft.Web/sites/', parameters('siteName'), '/slots/staging', '/config/appsettings')]"
              ],
              "tags": {
                "displayName": "connectionstrings"
              },
              "properties": {
                "SurveyCatalog": {
                  "type": "SQLAzure",
                  "value": "[parameters('surveyCatalog')]"
                },
                "NfieldStorageAccount": {
                  "type": "Custom",
                  "value": "[parameters('nfieldStorageAccount')]"
                },
                "ReportingServiceBus": {
                  "type": "Custom",
                  "value": "[parameters('reportingServiceBusStaging')]"
                },
                "AzureWebJobsServiceBus": {
                  "type": "Custom",
                  "value": "[parameters('azureWebJobsServiceBus')]"
                },
                "ManagerCacheConnection": {
                  "type": "Custom",
                  "value": "[parameters('managerCacheConnection')]"
                },
                "RedisCacheConfiguration": {
                  "type": "Custom",
                  "value": "[parameters('redisCacheConfiguration')]"
                }
              }
            }
          ]
        }
      ]
    },
    {
      "apiVersion": "2020-02-02",
      "condition": "[variables('siteApplicationInsightsEnabled')]",
      "name": "[parameters('siteName')]",
      "type": "Microsoft.Insights/components",
      "location": "[parameters('appInsightsLocation')]",
      "dependsOn": [
        "[concat('Microsoft.Web/sites/', parameters('siteName'))]"
      ],
      "tags": {
        "[concat('hidden-link:', resourceGroup().id, '/providers/Microsoft.Web/sites/', parameters('siteName'))]": "Resource",
        "displayName": "API - AppInsightsComponent"
      },
      "properties": {}
    }
  ]
}
