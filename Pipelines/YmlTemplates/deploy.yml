parameters:
  - name: stageDependency
    type: string
  - name: pipelineDependency
    type: string
    default: current
  - name: nuGetFeedType
    type: string
  - name: commitId
    type: string

stages:
  - stage: SDKNugetPublishing
    displayName: "SDK nuget ${{ parameters.nuGetFeedType }} Publishing"
    dependsOn: ["${{ parameters.stageDependency }}"]
    # SDK publishing stage will be skipped if the build is BatchedCI to validate a PR. So you'll need to run it manually if you want to deploy it.
    condition: succeeded()
    variables:
      - group: NfieldSDKSecretsGlobal
      - name: baseRoute
        ${{ if eq(parameters.pipelineDependency, 'current') }}:
          value: ""
        ${{ if not( eq(parameters.pipelineDependency, 'current')) }}:
          value: ${{ parameters.pipelineDependency }}
      - name: nugetPath
        ${{ if eq(parameters.nuGetFeedType, 'external') }}:
          value: "Release"
        ${{ if not( eq(parameters.nuGetFeedType, 'external')) }}:
          value: "Prerelease"
    jobs:
      - deployment: SDKNugetPublish
        displayName: Publising on ${{ parameters.nuGetFeedType }} Feed
        environment: ${{ format('NfieldSDK{0}Feed', parameters.nuGetFeedType) }}
        continueOnError: false
        strategy:
          runOnce:
            deploy:
              steps:
                # Download the 'for-deploy' artifacts
                - download: ${{ parameters.pipelineDependency }}
                  artifact: for-deploy
                  patterns: |
                    **/for-deploy/**
                    **/Pipelines/**
                # Publish NuGet package
                - task: NuGetCommand@2
                  displayName: 'NuGet push'
                  continueOnError: True
                  inputs:
                    command: push
                    packagesToPush: '$(Pipeline.Workspace)/$(baseRoute)/for-deploy/$(nugetPath)/*.nupkg'
                    nuGetFeedType: ${{ parameters.nuGetFeedType }}
                    publishFeedCredentials: 'NuGet (Publish)' # Used only for external feed
                    publishVstsFeed: 'nfield' # Used only for internal feed
                  condition: succeeded()

                # - task: gitreleasemanager/create@0
                #   displayName: 'Create Git release'
                #   inputs:
                #     owner: 'NIPOSoftwareBV'
                #     repository: 'Nfield-SDK'
                #     token: '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'
                #     name: 'Test Release'
                #     targetcommitish: '972d2c23a4866b45206443e276209554144cb6d1'
                #     isPreRelease: true
                      
                - task: PowerShell@1
                  displayName: 'Get NuGet Version'
                  inputs:
                    scriptName: '$(Pipeline.Workspace)/$(baseRoute)/for-deploy/Pipelines/Scripts/GetNugetVersion.ps1'

                - task: PowerShell@2
                  displayName: 'Publish Github release (if needed)'
                  inputs:
                    targetType: filePath
                    filePath: '$(Pipeline.Workspace)/$(baseRoute)/for-deploy/Pipelines/Scripts/PublishGitRelease.ps1'
                    arguments: '-AccessToken $(GitAccessToken) -ReleaseId ${{ parameters.commitId }} -Version $(Version)' #Created with GetNugetVersion.ps1
                    errorActionPreference: continue
                  continueOnError: true